# 从输入 URL 到页面展示发生了什么

这个过程涉及到浏览器各个进程之间的配合。

- **浏览器进程 **负责界面显示、用户交互、子进程管理和文件存储等功能
- **网络进程 **主要负责网络资源加载
- **渲染进程 **主要负责将 HTML、CSS、JS、图片等资源解析为可显示和交互的页面

## 1. 导航阶段

从用户发出 URL 请求到页面开始解析的过程就是导航。

### 1.1 用户输入

当用户在地址栏输入 URL 时，浏览器进程会检查 URL，拼上协议，组装成完整的 URL。

在这个阶段会触发当前页面的 beforeunload 事件，如果当前页面没有监听 beforeunload 事件或用户点击了继续，就会进入下一个阶段。

### 1.2 URL 请求

浏览器进程通过进程间通信（IPC）把 URL 请求发送至网络进程，网络进程就会发起 URL 请求流程

1. 查找本地缓存中是否有该资源，如果有就直接返回资源给浏览器进程，如果没有就进入下一步
2. 通过 DNS 解析获取请求域名的服务器 IP 地址，利用 IP 地址和服务器建立 TCP 连接。
3. 建立连接后，浏览器构建请求行、请求头、请求体等信息，向服务器发送请求信息
4. 服务器接受到请求后，会根据请求信息生成响应数据（包括响应行、响应头、响应体），返回给网络进程
5. 网络进程接收响应数据之后，就开始解析响应行和响应头的内容
   - 如果响应行中状态码是 301（永久重定向） 或 302（临时重定向），说明服务器将请求重定向了。网络进程会读取响应头的 Location 字段，发起新的请求。
   - 根据响应头中的 Content-Type 字段决定后续处理流程，如果是 HTML，浏览器会为页面分配一个渲染进程（不一定会新建，可能会复用）

### 1.3 提交文档

提交文档是指浏览器进程将网络进程接收到的 HTML 数据提交给渲染进程。

1. 浏览器进程向渲染进程发起”提交文档“的消息
2. 渲染进程接收后，会和网络进程建立传输数据的管道
3. 文档数据传输完成之后，渲染进程会返回”确认提交“的消息给浏览器进程
4. 浏览器进程收到”确认提交“消息后，会更新浏览器界面状态，包括安全状态、地址栏 URL、前进后退的历史状态，并更新页面

至此，导航阶段完成，要进入渲染阶段

## 2. 渲染阶段

### 2.1 构建 DOM 树

浏览器无法直接理解和使用 HTMl，需要将 HTML 转换为浏览器能理解的 DOM 树结构

### 2.2 样式计算

计算出 DOM 节点中每个元素的样式

#### 2.2.1 CSS 转换为 styleSheets

渲染引擎把 CSS 文本转换为浏览器可以理解的 styleSheets 结构，这个结构同时具备查询和修改的功能

#### 2.2.2 属性值标准化

把 CSS 中的非标准属性值（em、blue、bold等等）转换为渲染引擎可理解的标准的计算值

#### 2.2.3 计算 DOM 节点样式

根据 CSS 的继承规则和层叠规则计算出 DOM 树中每个节点的样式，保存在 ComputedStyle 结构

### 2.3 布局阶段

目前每个 DOM 节点的最终样式已经计算出来，要完成布局，还需要计算出 DOM 树中可见元素的几何位置，这个过程就是布局。

#### 2.3.1 创建布局树

遍历 DOM 树中的所有节点，把可见节点添加到布局树中。

#### 2.3.2 布局计算

根据布局树中节点的样式，计算出每个节点的布局信息（坐标、大小等等）。

### 2.4 分层和绘制

#### 2.4.1 分层

渲染引擎根据分层规则为特定的节点生成专用图层，并生成一棵图层树（LayerTree）。浏览器的页面实际上被分为很多图层，这些图层叠加后合成了最终的页面。

#### 2.4.2 图层绘制

完成图层树的构建后，渲染引擎把每个图层的绘制拆分为很多小的绘制指令，然后把这些指令按照顺序组成一个绘制列表。

![绘制列表](https://static001.geekbang.org/resource/image/40/08/40825a55214a7990bba6b9bec6e54108.png)

#### 2.4.3 栅格化操作

绘制列表只是用来记录绘制顺序和绘制指令的列表，实际的绘制操作是由渲染引擎的合成线程完成的。

图层绘制列表准备好之后，主线程会把绘制列表提交给合成线程，合成线程把图层划分为图块，栅格化的操作实际上就是将图块转换为位图。

#### 2.4.4 合成和显示

所有图层都被栅格化后，合成线程就会把绘制图块的命令提交给浏览器进程，浏览器进程就会把页面内容绘制到内存中，最后再讲内存显示在屏幕上。

### 渲染阶段概览

1. 渲染进程将 HTML 内容转换为能够读懂的 DOM 树结构。
2. 渲染引擎将 CSS 样式表转化为浏览器可以理解的 styleSheets，计算出 DOM 节点的样式。
3. 创建布局树，并计算元素的布局信息。
4. 对布局树进行分层，并生成分层树。
5. 为每个图层生成绘制列表，并将其提交到合成线程。
6. 合成线程将图层分成图块，并在光栅化线程池中将图块转换成位图。
7. 合成线程发送绘制图块命令给浏览器进程。浏览器进程根据绘制命令生成页面，并显示到显示器上。